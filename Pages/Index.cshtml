@page
@model IndexModel
@using GuideLens.Models

@{
    // We still build this in case you want to keep the JSON link later,
    // but we’re no longer showing it in the UI.
    var baseApi = Url.Content("~/api/recommendations");
    var city = System.Uri.EscapeDataString(Model.Query.City ?? "");
    var q = System.Uri.EscapeDataString(Model.Query.Q ?? "");
    var neighborhood = System.Uri.EscapeDataString(Model.Query.Neighborhood ?? "");

    var apiUrl = $"{baseApi}" +
                 $"?city={city}" +
                 $"&q={q}" +
                 $"&category={Model.Query.Category}" +
                 $"&neighborhood={neighborhood}" +
                 $"&sortBy={Model.Query.SortBy}" +
                 $"&page={Model.Query.Page}" +
                 $"&pageSize={Model.Query.PageSize}";

    bool hasResults = Model.Results?.Items?.Any() == true;
}

<!-- FULL-SCREEN HERO WITH SEARCH INSIDE -->
<section class="gl-hero-full d-flex align-items-center text-center"
         style="background-image:url('@Url.Content("~/img/Hero-img.jpg")')">
    <div class="gl-hero-inner container">
        <div class="mb-4">
            <h1 class="display-4 fw-bold mb-2 text-white">GuideLens</h1>
            <p class="lead mb-0 text-white-50">
                A curated, offline-first guide to Cincinnati &amp; Ohio
            </p>
        </div>

        <!-- SEARCH PANEL FLOATING ON THE HERO IMAGE -->
        <form method="get"
              class="gl-search-panel hero-search bg-white rounded-3 shadow-lg p-3 p-md-4">
            <div class="row g-3 align-items-end">

                <!-- City -->
                <div class="col-12 col-md-3">
                    <label class="form-label">City</label>
                    <select asp-for="Query.City" class="form-select">
                        @foreach (var c in Model.Cities)
                        {
                            <option value="@c" selected="@(Model.Query.City == c)">@c</option>
                        }
                    </select>
                </div>

                <!-- Search -->
                <div class="col-12 col-md-5">
                    <label class="form-label" for="search-box">Search</label>
                    <input asp-for="Query.Q"
                            id="Search-box"
                           class="form-control"
                           placeholder="Try Skyline, museum, park..." />
                </div>

                <!-- Category -->
                <div class="col-12 col-md-3">
                    <label class="form-label">Category</label>
                    <select asp-for="Query.Category"
                            class="form-select"
                            asp-items="Html.GetEnumSelectList<CategoryFilter>()">
                    </select>
                </div>

                <!-- Apply -->
                <div class="col-12 col-md-1 text-md-end">
                    <button class="btn btn-primary w-100 mt-2 mt-md-0" aria-label="Apply Filters">Apply</button>
                </div>
            </div>

            <p class="small text-muted mt-3 mb-0 text-start">
                Start by searching for a place, food, or neighborhood and then click <strong>Apply</strong>.
            </p>
        </form>
    </div>
</section>

<!-- RESULTS SECTION BELOW THE HERO -->
<div class="container py-4">

    @* Optional info note when a non-Cincinnati city is chosen (data coming soon) *@
    @if (Model.ComingSoon)
    {
        <div class="alert alert-info border mb-3">
            <strong>@Model.Query.City</strong> data coming soon.
        </div>
    }

    @if (hasResults)
    {
        <!-- Summary -->
        <div class="mb-3">
            <strong>@Model.Results.TotalCount</strong> total matches.
            Showing page <strong>@Model.Query.Page</strong> of <strong>@Model.Results.TotalPages</strong>.
        </div>

        <!-- Cards Grid -->
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
            @foreach (var r in Model.Results.Items)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body">
                            <h5 class="card-title mb-1">@r.Name</h5>
                            <div class="small text-muted mb-2">
                                @r.Category • @r.Neighborhood
                            </div>

                            @if (!string.IsNullOrWhiteSpace(r.TheBestOffer))
                            {
                                <p class="mb-2"><strong>Best Offer:</strong> @r.TheBestOffer</p>
                            }
                            @if (!string.IsNullOrWhiteSpace(r.NoteTip))
                            {
                                <p class="mb-2"><strong>Tip:</strong> @r.NoteTip</p>
                            }

                            <div class="mt-2 d-flex flex-wrap gap-2">
                                <!-- Photo Time Hint -->
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary gl-photo-hint"
                                        data-place="@r.Name"
                                        data-city="@Model.Query.City">
                                    Photo time hint
                                </button>

                                <!-- About this place -->
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary gl-about-place"
                                        data-title="@r.Name"
                                        data-lang="en">
                                    About this place
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (Model.Results.TotalPages > 1)
        {
            <nav class="mt-4" aria-label="pagination">
                <ul class="pagination justify-content-center">
                    @{
                        int prev = Math.Max(1, Model.Query.Page - 1);
                        int next = Math.Min(Model.Results.TotalPages, Model.Query.Page + 1);
                    }

                    <li class="page-item @(Model.Query.Page == 1 ? "disabled" : "")">
                        <a class="page-link"
                           asp-page="./Index"
                           asp-route-Q="@Model.Query.Q"
                           asp-route-Category="@Model.Query.Category"
                           asp-route-Neighborhood="@Model.Query.Neighborhood"
                           asp-route-SortBy="@Model.Query.SortBy"
                           asp-route-City="@Model.Query.City"
                           asp-route-Page="@prev"
                           asp-route-PageSize="@Model.Query.PageSize">
                            Prev
                        </a>
                    </li>

                    @for (int p = 1; p <= Model.Results.TotalPages; p++)
                    {
                        <li class="page-item @(p == Model.Query.Page ? "active" : "")">
                            <a class="page-link"
                               asp-page="./Index"
                               asp-route-Q="@Model.Query.Q"
                               asp-route-Category="@Model.Query.Category"
                               asp-route-Neighborhood="@Model.Query.Neighborhood"
                               asp-route-SortBy="@Model.Query.SortBy"
                               asp-route-City="@Model.Query.City"
                               asp-route-Page="@p"
                               asp-route-PageSize="@Model.Query.PageSize">
                                @p
                            </a>
                        </li>
                    }

                    <li class="page-item @(Model.Query.Page == Model.Results.TotalPages ? "disabled" : "")">
                        <a class="page-link"
                           asp-page="./Index"
                           asp-route-Q="@Model.Query.Q"
                           asp-route-Category="@Model.Query.Category"
                           asp-route-Neighborhood="@Model.Query.Neighborhood"
                           asp-route-SortBy="@Model.Query.SortBy"
                           asp-route-City="@Model.Query.City"
                           asp-route-Page="@next"
                           asp-route-PageSize="@Model.Query.PageSize">
                            Next
                        </a>
                    </li>
                </ul>
            </nav>
        }
    }
</div>
<!-- ABOUT PLACE MODAL (Wikipedia summary) -->
<div class="modal fade" id="aboutPlaceModal" tabindex="-1"
     aria-labelledby="aboutPlaceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aboutPlaceModalLabel">About this place</h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <p id="aboutPlaceModalExtract" class="mb-0 small text-muted">
                    <!-- JS will inject the summary text here -->
                </p>
            </div>

            <div class="modal-footer d-flex justify-content-between">
                <small id="aboutPlaceModalSource" class="text-muted">
                    Source: Wikipedia
                </small>
                <a id="aboutPlaceReadMore"
                   href="#"
                   target="_blank"
                   rel="noopener"
                   class="btn btn-outline-secondary btn-sm">
                    Read full article
                </a>
            </div>
        </div>
    </div>
</div>
