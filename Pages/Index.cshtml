@page
@model IndexModel
@using GuideLens.Models
@using System.Text.Json

@{
    ViewData["Title"] = "Home";

    // A search has been performed whenever there is any query string
    bool hasQuery = !Model.IsInitialSearch;
    bool hasResults = Model.Results?.Items?.Any() == true;
}

<section class="gl-hero-full d-flex align-items-center text-center"
         style="background-image:url('@Url.Content("~/img/Hero-img.jpg")')">
    <div class="gl-hero-inner container">
        <div class="mb-4">
            <h1 class="display-4 fw-bold mb-2 text-white">GuideLens</h1>
            <p class="lead mb-0 text-white-50">Cincinnati &amp; Ohio</p>
        </div>

        <form method="get" class="gl-search-panel hero-search rounded-3 shadow-lg p-3 p-md-4" id="glSearchForm">
            <div class="row g-3 align-items-end">

                <!-- City: typeahead + placeholder -->
                <div class="col-12 col-md-3">
                    <label class="form-label">City</label>

                    <input asp-for="Query.City"
                           id="glCity"
                           class="form-control"
                           placeholder="Select a city..."
                           list="city-suggestions"
                           autocomplete="off" />

                    <!-- stays empty; JS fills only after typing -->
                    <datalist id="city-suggestions"></datalist>

                    <small id="glCityError" class="text-danger d-none">
                        Please select a city from the list.
                    </small>
                </div>

                <!-- Search: typeahead -->
                <div class="col-12 col-md-5">
                    <label class="form-label">Search</label>

                    <input asp-for="Query.Q"
                           id="glSearch"
                           class="form-control"
                           placeholder="Type to search (e.g., Skyline, museum, park...)"
                           list="search-suggestions"
                           autocomplete="off" />

                    <datalist id="search-suggestions"></datalist>
                </div>

                <!-- Category -->
                <div class="col-12 col-md-3">
                    <label class="form-label">Category</label>
                    <select asp-for="Query.Category"
                            class="form-select"
                            asp-items="Html.GetEnumSelectList<CategoryFilter>()">
                    </select>
                </div>

                <!-- Apply -->
                <div class="col-12 col-md-1 text-md-end">
                    <button class="btn btn-primary w-100 mt-2 mt-md-0">Apply</button>
                </div>
            </div>

            <p class="small text-muted mt-3 mb-0 text-start">
                Choose a city and type something in <strong>Search</strong>, then click <strong>Apply</strong>.
            </p>
        </form>
    </div>
</section>

<div class="container py-4">

    @* Info banner for non-Cincinnati cities *@
    @if (Model.ComingSoon
        && !string.IsNullOrWhiteSpace(Model.Query?.City)
        && !string.Equals(Model.Query.City, "Cincinnati", StringComparison.OrdinalIgnoreCase))
    {
        <div class="alert alert-info border mb-3">
            <strong>@Model.Query.City</strong> data coming soon.
        </div>
    }

    @* Only show empty states / results when we actually have data (i.e., Cincinnati) *@
    @if (!Model.ComingSoon)
    {
        @if (!hasQuery)
        {
            <div class="gl-empty">
                <strong>No results yet.</strong>
                <div class="text-muted">Type something in the Search box and hit Apply.</div>
            </div>
        }
        else if (!hasResults)
        {
            <div class="gl-empty">
                <strong>No matches found.</strong>
                <div class="text-muted">Try a different keyword (or category) and hit Apply.</div>
            </div>
        }
        else
        {
            <div class="mb-3">
                <strong>@Model.Results!.TotalCount</strong> total matches.
                Showing page <strong>@Model.Query.Page</strong> of <strong>@Model.Results.TotalPages</strong>.
            </div>

            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
                @foreach (var r in Model.Results!.Items)
                {
                    <div class="col">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title mb-1">@r.Name</h5>
                                <div class="small text-muted mb-2">@r.Category • @r.Neighborhood</div>

                                @if (!string.IsNullOrWhiteSpace(r.TheBestOffer))
                                {
                                    <p class="mb-2"><strong>Best Offer:</strong> @r.TheBestOffer</p>
                                }

                                @if (!string.IsNullOrWhiteSpace(r.NoteTip))
                                {
                                    <p class="mb-2"><strong>Tip:</strong> @r.NoteTip</p>
                                }

                                <div class="mt-2 d-flex flex-wrap gap-2">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary gl-photo-hint"
                                            data-place="@r.Name"
                                            data-city="@Model.Query.City">
                                        Photo time hint
                                    </button>

                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary gl-about-place"
                                            data-title="@r.Name"
                                            data-lang="en">
                                        About this place
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

<!-- About modal -->
<div class="modal fade" id="aboutPlaceModal" tabindex="-1"
     aria-labelledby="aboutPlaceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aboutPlaceModalLabel">About this place</h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <p id="aboutPlaceModalExtract" class="mb-0 small text-muted"></p>
            </div>

            <div class="modal-footer d-flex justify-content-between">
                <small id="aboutPlaceModalSource" class="text-muted">Source: Wikipedia</small>
                <a id="aboutPlaceReadMore"
                   href="#"
                   target="_blank"
                   rel="noopener"
                   class="btn btn-outline-secondary btn-sm">
                    Read full article
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const form = document.getElementById("glSearchForm");

            const cityInput = document.getElementById("glCity");
            const cityDL = document.getElementById("city-suggestions");
            const cityErr = document.getElementById("glCityError");

            const searchInput = document.getElementById("glSearch");
            const searchDL = document.getElementById("search-suggestions");

            const cities = @Html.Raw(JsonSerializer.Serialize(Model.Cities ?? new List<string>()));
            const allNames = @Html.Raw(JsonSerializer.Serialize(Model.AllNames ?? new List<string>()));

            const MAX_CITY = 10;
            const MAX_SEARCH = 18;

            function fillDatalist(dl, items, term, minLen, maxItems) {
                dl.innerHTML = "";
                const t = (term || "").trim().toLowerCase();
                if (t.length < minLen) return;

                let count = 0;
                for (const it of items) {
                    if (!it) continue;
                    if (it.toLowerCase().includes(t)) {
                        const opt = document.createElement("option");
                        opt.value = it;
                        dl.appendChild(opt);
                        count++;
                        if (count >= maxItems) break;
                    }
                }
            }

            // City: list appears only after typing 1+ char
            if (cityInput && cityDL) {
                cityInput.addEventListener("input", e => {
                    cityErr?.classList.add("d-none");
                    fillDatalist(cityDL, cities, e.target.value, 1, MAX_CITY);
                });

                cityInput.addEventListener("focus", () => {
                    // DO NOT show list unless user typed something
                    fillDatalist(cityDL, cities, cityInput.value, 1, MAX_CITY);
                });

                // If they click and it's empty, keep it empty
                cityInput.addEventListener("click", () => {
                    if (!(cityInput.value || "").trim()) cityDL.innerHTML = "";
                });
            }

            // Search: list appears only after typing 2+ chars
            if (searchInput && searchDL) {
                searchInput.addEventListener("input", e =>
                    fillDatalist(searchDL, allNames, e.target.value, 2, MAX_SEARCH)
                );

                searchInput.addEventListener("focus", () =>
                    fillDatalist(searchDL, allNames, searchInput.value, 2, MAX_SEARCH)
                );

                searchInput.addEventListener("click", () => {
                    if (((searchInput.value || "").trim().length) < 2) searchDL.innerHTML = "";
                });
            }

            // Optional: prevent submitting an invalid city value (must be from list)
            if (form && cityInput) {
                form.addEventListener("submit", (e) => {
                    const v = (cityInput.value || "").trim();
                    if (!v) return; // allow empty if you want
                    const ok = cities.includes(v);
                    if (!ok) {
                        e.preventDefault();
                        cityErr?.classList.remove("d-none");
                        cityInput.focus();
                    }
                });
            }
        })();
    </script>
}
